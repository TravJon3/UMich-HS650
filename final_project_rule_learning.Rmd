---
title: "Final Project Fule Learning"
subtitle: "Clustering Nearest Neighbor"
author: "Kevin Wu"
date: "`r format(Sys.time(), '%B %Y')`"
tags: [DSPA, SOCR, MIDAS, Big Data, Predictive Analytics] 
output:
  html_document:
    theme: spacelab
    highlight: tango
    toc: true
    number_sections: true
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: true
    code_folding: show
    self_contained: yes
---
**final_project_rule_learning.Rmd**.

# Rule Learning
<p>apriori - nominal/categorical variables with each </p>

```{r Common, warning=F, message=F, include=F, child='final_project_common.Rmd'}
```

## Apriori Helper Functions and Libraries
```{r Header, warning=F, message=F}
library(arules)

join_descriptions <- function(df, df_stat) {
  df_new <- df
  colname <- colnames(df_new)
  colname <- colname[!colname %in% "PositiveChange"]
  for(i in 1:length(colname)) {
    if(is.null(attributes(df_stat[[colname[i]]])$class) == F && attributes(df_stat[[colname[i]]])$class != "factor" && attributes(df_stat[[colname[i]]])$class[3] == "double") {
      if(is.null(attributes(df_stat[[colname[i]]])$labels) == F && length(attributes(df_stat[[colname[i]]])$labels) > 0) {
        vect_labels <- attributes(df_stat[[colname[i]]])$labels
        df_new[colname[i]] <- lapply(df_new[colname[i]], as.character)
        for(l in 1:length(vect_labels)) {
          df_new[colname[i]] <- replace(df_new[colname[i]], df_new[colname[i]] == vect_labels[l], trimws(names(vect_labels)[l]))
        }
      }
    }
  }
  return(df_new)
}

tranasctions_to_vector_descriptions <- function(trans) {
  unsubbed_summary <- names(attr(summary(trans),"itemSummary"))
  vector_subbed_summary <- gsub("\\=.+$", unsubbed_summary, replacement = "")
  lapply(vector_subbed_summary, fieldname_to_description)  
}
```

## Apriori Learning - Full Dataset
```{r AprioriFull, warning=F, message=F}
df_full_apriori <- join_descriptions(df_full_na, tbl_dta)
transactions_full <- transactions(df_full_apriori)
summary(transactions_full)
inspect(transactions_full[1:5,])
as.matrix(tranasctions_to_vector_descriptions(transactions_full))

itemFrequency(transactions_full[, 1:10])

# mat <- as.matrix(transactions@data)
# # capture the row/column names
# rowNames <- transactions@itemInfo$labels
# colNames <- paste0("S", c(1:dim(mat)[2]))
# rownames(mat) <- rowNames
# colnames(mat) <- colNames
# 
# # convert matrix to DF for processing, order rows based on their average (across subjects/cases/columns), back to matrix for display
# df <- as.data.frame(1*mat)
# df$avg <- rowMeans(df)
# dfOrdered <- df[order(df$avg, decreasing = T), ]
# matOrdered <- as.matrix(dfOrdered)
# 
# # track the ordered row names
# rowNames <- rownames(dfOrdered)
# colNames <- colnames(dfOrdered)
# 
# # 2D top 20 terms bar plot
# # To order the transactions based on "avg", instead of alphabetically (mind the "-" sign to order Large to small!)
# plot_ly(x = reorder(rowNames[c(1:20)], -dfOrdered[1:20, "avg"]), y=dfOrdered[1:20, "avg"], name="Top 20 Meds", type="bar")  %>%
#   layout(title='Frequency of Medications (Top 20) based on averaging across Cases',
#            xaxis = list(title="Term"),
#            yaxis = list(title="Relative Frequency"))
# # 3D surface plot
# plot_ly(x = colNames, y = rowNames, z = 2*matOrdered, type = "surface") %>%
#   layout(title='Term (X) by Sample (Y) Frequency (Z) Plot',
#            xaxis = list(title="Term"),
#            yaxis = list(title="Sample ID")) %>% hide_colorbar()

##for rules
myrules_full <- apriori(transactions_full, parameter = list(support = 0.25))
myrules_full
summary(myrules_full)
inspect(head(sort(myrules_full, by="lift"), n = 50))
```

## Apriori Learning - Objective Dataset
```{r AprioriObjective, warning=F, message=F}
df_objective_apriori <- join_descriptions(df_objective_na, tbl_dta)
transactions_objective <- transactions(df_objective_apriori)
summary(transactions_objective)
inspect(transactions_objective[1:5,])
as.matrix(tranasctions_to_vector_descriptions(transactions_objective))
itemFrequency(transactions_objective[, 1:10])

myrules_objective <- apriori(transactions_objective, parameter = list(support = 0.25))
myrules_objective
summary(myrules_objective)
inspect(head(sort(myrules_objective, by="lift"), n = 50))
```
