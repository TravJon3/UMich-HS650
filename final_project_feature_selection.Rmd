---
title: "Final Project"
subtitle: "Feature Selection"
author: "Kevin Wu"
date: "`r format(Sys.time(), '%B %Y')`"
tags: [DSPA, SOCR, MIDAS, Big Data, Predictive Analytics] 
output:
  html_document:
    theme: spacelab
    highlight: tango
    toc: true
    number_sections: true
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: true
    code_folding: show
    self_contained: yes
---
**final_project_feature_selection.Rmd**.

# Feature Selection Introduction
<p>I used the Boruta algorithm for its feature selection.  The problem is that the features aren't ordered by any statistical significance.  For this reason, I decided to use the ordinary least squares model to help both confirm the features selected by the Boruta model, but also to determine the more significant features affecting PositiveChange.  I'm hoping to select the common features between the two models, and use the ordering information from the OLS model.
<p>I've decided against using the RFE model because Boruta is based on the RFE model.</p>

```{r Common, warning=F, message=F, include=F, child='final_project_common.Rmd'}
```

```{r Header, warning=F, message=F}
library(Boruta)
library(mlbench)

run_stepwise <- function(df_run) {
  set.seed(1234)
  base.mod <- lm(PositiveChange ~ 1, data = df_run)
  # Define the full model - including all predictors
  all.mod <- lm(PositiveChange ~ ., data = df_run)
  ols_step <- lm(PositiveChange ~ ., data = df_run)
  ols_step <- step(base.mod, scope = list(lower = base.mod, upper = all.mod), direction = 'both', k = 2, trace = F)
}

formula_to_vector_descriptions <- function(formula) {
  vector_untranslated <- trimws(strsplit(as.character(formula[3]), "\\+")[[1]])
  vector_translation <- lapply(vector_untranslated, fieldname_to_description)
  return(vector_translation)
}

lm_to_summary_model <- function(lmodel) {
  sum_ols <- summary(lmodel)
  df_ols_model <- as.data.frame(as.matrix(lapply(names(lmodel$coefficients), fieldname_to_description)))
  vect_pvals <- unname(sum_ols$coefficients[, 4])
  vect_stars <- lapply(vect_pvals, function(x) {
      if(x > 0 & x < 0.001)
        return("***")
      else if(x >= 0.001 & x < 0.01)
        return("**")
      else if(x >= 0.01 & x < 0.05)
        return("*")
      else if(x >= 0.05 & x < 0.1)
        return(".")
      else if(x >= 0.1 & x < 1)
        return("_")
    })
  df_ols_model <- cbind(Variables = df_ols_model$V1, pvalues = vect_pvals, Stars = vect_stars)
  as.data.frame(df_ols_model[order(vect_pvals), ])
}

```

## Boruta - Full Dataset
```{r BorutaFull, warning=F, message=F}
set.seed(1234)
boruta_full <- Boruta(PositiveChange ~ ., data = df_full_scaled)
print(boruta_full)
#boruta_full <- TentativeRoughFix(boruta_full)
descriptions_full <- formula_to_vector_descriptions(getConfirmedFormula(boruta_full))
paste(descriptions_full, collapse = " + ")
#print(boruta_full$finalDecision[boruta_full$finalDecision %in% c("Confirmed", "Tentative")])

df_long <- gather(as.data.frame(boruta_full$ImpHistory), feature, measurement)
plot_ly(df_long, y = ~measurement, color = ~feature, type = "box") %>%
  layout(title="Box-and-whisker Plots Across All Features",
           xaxis = list(title="Features"),
           yaxis = list(title="Importance"),
           showlegend=F)
```

## Boruta - Objective Dataset
```{r BorutaObjective, warning=F, message=F}
set.seed(1234)
boruta_objective <- Boruta(PositiveChange ~ ., data = df_objective_scaled)
print(boruta_objective)
#boruta_objective <- TentativeRoughFix(boruta_objective)
descriptions_objective <- formula_to_vector_descriptions(getConfirmedFormula(boruta_objective))
paste(descriptions_objective, collapse = " + ")
#print(boruta_objective$finalDecision[boruta_objective$finalDecision %in% c("Confirmed", "Tentative")])

df_objective_long <- gather(as.data.frame(boruta_objective$ImpHistory), feature, measurement)
plot_ly(df_objective_long, y = ~measurement, color = ~feature, type = "box") %>%
  layout(title="Box-and-whisker Plots Across Objective Features",
           xaxis = list(title="Features"),
           yaxis = list(title="Importance"),
           showlegend=F)
```

## Stepwise Feature Selection - Full Dataset
```{r StepwiseFull, warning=F, message=F}
ols_full <- run_stepwise(df_full_scaled)
df_ols_model_full_trans <- lm_to_summary_model(ols_full)
df_ols_model_full_trans

# # get the shortlisted variable
# ols_confirmed_vars_full <- names(unlist(ols_full[[1]]))
# # remove the intercept 
# ols_confirmed_vars_full <- ols_confirmed_vars_full[!ols_confirmed_vars_full %in% "(Intercept)"]
# print(ols_confirmed_vars_full)
# # estimate variable importance
# pred_ols_full <- varImp(ols_full, scale=FALSE)
# # summarize importance
# print(pred_ols_full)
```

## Stepwise Feature Selection - Objective Dataset
```{r StepwiseObjective, warning=F, message=F}
ols_objective <- run_stepwise(df_objective_scaled)
df_ols_model_objective_trans <- lm_to_summary_model(ols_objective)
df_ols_model_objective_trans
# # get the shortlisted variable
# ols_confirmed_vars_objective <- names(unlist(ols_objective[[1]]))
# # remove the intercept 
# ols_confirmed_vars_objective <- ols_confirmed_vars_objective[!ols_confirmed_vars_objective %in% "(Intercept)"]
# print(ols_confirmed_vars_objective)
# # estimate variable importance
# pred_ols_objective <- varImp(ols_objective, scale=FALSE)
# # summarize importance
# print(pred_ols_objective)
```

# Summary
As you will see below, the full featured dataset contains more pertinent data that is more than subjective data.  In this situation, it appears including the subjective variables provides more data to the algorithms.
```{r Summary, warning=F, message=F}
df_full_feauture_selection_combined <- as.data.frame(df_ols_model_full_trans[is.element(set = df_ols_model_full_trans$Variables, el = as.matrix(descriptions_full)), ])
df_objective_feature_selection_combined <- as.matrix(df_ols_model_objective_trans[is.element(set = df_ols_model_objective_trans$Variables, el = as.matrix(descriptions_objective)), ])
print("Combination of Boruta and OLS Full Datasets ")
df_full_feauture_selection_combined
print("Combination of Boruta and OLS Objective Datasets ")
df_objective_feature_selection_combined
```